<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marstek Venus - BLE Test Tool</title>
    <meta name="description" content="Web-based battery monitoring tool for Marstek Venus batteries via Bluetooth Low Energy">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Command Info Modal -->
    <div id="infoModal" class="info-modal">
        <div class="info-modal-content">
            <span class="info-modal-close" onclick="closeInfoModal()">&times;</span>
            <div id="commandDetails" class="command-details"></div>
        </div>
    </div>

    <!-- Disclaimer Modal -->
    <div id="disclaimerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">âš ï¸ EXPERIMENTAL SOFTWARE WARNING âš ï¸</div>
            
            <div class="disclaimer-text">
                <p><strong>This is highly experimental testing software for Marstek Venus batteries.</strong></p>
                
                <div class="warning-box">
                    <strong>IMPORTANT WARNINGS:</strong>
                    <ul>
                        <li>This software can send commands to your battery system</li>
                        <li>Some commands may modify battery settings or behavior</li>
                        <li>Improper use could potentially damage your equipment</li>
                        <li>This tool is for advanced users and developers only</li>
                        <li>Use in a controlled environment with proper safety precautions</li>
                    </ul>
                </div>
                
                <p><strong>By continuing, you acknowledge that:</strong></p>
                <ul>
                    <li>You understand the experimental nature of this software</li>
                    <li>You accept full responsibility for any consequences</li>
                    <li>You will not hold the developers liable for any damages</li>
                    <li>You have proper knowledge of battery systems and safety</li>
                    <li>You will use this tool at your own risk</li>
                </ul>
                
                <p><strong>Supported Equipment:</strong> Marstek Venus batteries with "MST_ACCP" and "MST-TPM" Bluetooth names.</p>
                
                <p><strong>Browser Requirements:</strong> Chrome, Edge, or Opera with Web Bluetooth support.</p>
            </div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="acceptRisk"> 
                <label for="acceptRisk">I understand the risks and agree to proceed at my own responsibility</label>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-decline" onclick="declineAndExit()">âŒ Exit Safely</button>
                <button class="btn-accept" id="acceptBtn" disabled onclick="acceptAndContinue()">âœ… Accept Risk & Continue</button>
            </div>
        </div>
    </div>

    <!-- Connection Retry Dialog -->
    <div id="retryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">ğŸ”Œ Connection Failed</div>
            
            <div class="disclaimer-text">
                <p>Unable to connect to the Marstek device after 3 attempts.</p>
                <p>This can happen due to:</p>
                <ul>
                    <li>Device is out of range or powered off</li>
                    <li>Another app is connected to the device</li>
                    <li>Bluetooth interference or device busy</li>
                    <li>Device needs to be reset or restarted</li>
                </ul>
                <p><strong>Would you like to try connecting again?</strong></p>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-decline" onclick="cancelRetry()">âŒ Cancel</button>
                <button class="btn-accept" onclick="retryConnection()">ğŸ”„ Retry Connection</button>
            </div>
        </div>
    </div>

    <!-- Main Interface -->
    <div class="main-interface" id="mainInterface">
        <div class="container">
            <h1>ğŸ”‹ Marstek Venus - BLE Test Tool</h1>
            <p class="subtitle">Advanced BLE monitoring and diagnostics for Marstek battery systems</p>
            
            <!-- Version Links -->
            <div style="text-align: center; margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                <span style="color: #666; font-size: 14px;">ğŸ“ You're using: <strong>v2.0.1-beta</strong></span>
                <span style="margin: 0 10px;">|</span>
                <a href="https://rweijnen.github.io/marstek-venus-monitor/" style="color: #007bff; text-decoration: none;">
                    ğŸ”’ Switch to v1.0.0 (Stable)
                </a>
            </div>
            
            <div class="status">
                <span>Status: <span id="status" class="disconnected">Disconnected</span></span>
                <div>
                    <button onclick="connect()" id="connectBtn" class="btn-connect">Connect to Marstek</button>
                    <button onclick="disconnect()" id="disconnectBtn" disabled>Disconnect</button>
                    <button onclick="disconnectAll()" id="disconnectAllBtn">Disconnect All</button>
                    <button onclick="runAllTests()" id="runAllBtn" disabled>ğŸ§ª Run All Tests</button>
                    <button onclick="clearAll()">Clear All</button>
                </div>
            </div>
            
            <!-- Connection Status Messages -->
            <div id="connectionStatus" class="connection-status" style="display: none;">
                <div id="connectionMessage"></div>
            </div>

            <!-- Command Tabs Interface -->
            <div class="command-tabs-container">
                <div class="command-tabs">
                    <button class="command-tab-button active" onclick="switchCommandTab('read')">ğŸ“– Read</button>
                    <button class="command-tab-button" onclick="switchCommandTab('power')">âš¡ Power</button>
                    <button class="command-tab-button" onclick="switchCommandTab('system')">âš™ï¸ System</button>
                    <button class="command-tab-button" onclick="switchCommandTab('development')">ğŸ”§ Dev</button>
                    <button class="command-tab-button" onclick="switchCommandTab('network')">ğŸ•° Network</button>
                    <button class="command-tab-button" onclick="switchCommandTab('advanced')">ğŸ”§ Advanced</button>
                    <button class="command-tab-button" onclick="switchCommandTab('ota')">ğŸ”¥ OTA</button>
                </div>
                
                <!-- Command Tab Contents (Loaded Dynamically) -->
                <div id="readTab" class="command-tab active" data-loaded="true">
                    <div class="section-caption">
                        ğŸ“– <strong>Read Commands:</strong> These commands safely read information from your device including power status, battery data, network configuration, and system logs. No settings are modified.
                    </div>
                    <div class="command-grid">
                        <button onclick="sendCommand(0x03, 'Runtime Info')" disabled data-tooltip="Real-time power flow, temperatures, and system status" class="cmd-button">
                            <span class="cmd-button-text">âš¡ Runtime Info</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('runtime')">i</span>
                        </button>
                        <button onclick="sendCommand(0x04, 'Device Info')" disabled data-tooltip="Device model, MAC address, and firmware versions" class="cmd-button">
                            <span class="cmd-button-text">ğŸ“± Device Info</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('device')">i</span>
                        </button>
                        <button onclick="sendCommand(0x08, 'WiFi Info')" disabled data-tooltip="Connected WiFi network name (SSID)" class="cmd-button">
                            <span class="cmd-button-text">ğŸ“¶ WiFi Info</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('wifi')">i</span>
                        </button>
                        <button onclick="sendCommand(0x0D, 'Developer Mode Info')" disabled data-tooltip="Development mode configuration and debug parameters" class="cmd-button">
                            <span class="cmd-button-text">ğŸ› ï¸ Developer Mode Info</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('system')">i</span>
                        </button>
                        <button onclick="sendCommand(0x13, 'Error Codes')" disabled data-tooltip="Historical error codes with timestamps" class="cmd-button">
                            <span class="cmd-button-text">ğŸš¨ Error Codes</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('errors')">i</span>
                        </button>
                        <button onclick="sendCommand(0x14, 'BMS Data')" disabled data-tooltip="Battery voltages, current, SOC, and cell data" class="cmd-button">
                            <span class="cmd-button-text">ğŸ”‹ BMS Data</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('bms')">i</span>
                        </button>
                        <button onclick="sendCommand(0x1A, 'Config Data')" disabled data-tooltip="System configuration parameters" class="cmd-button">
                            <span class="cmd-button-text">âš™ï¸ Config Data</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('config')">i</span>
                        </button>
                        <button onclick="sendCommand(0x1C, 'Event Log')" disabled data-tooltip="System event history with timestamps" class="cmd-button">
                            <span class="cmd-button-text">ğŸ“ Event Log</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('events')">i</span>
                        </button>
                        <button onclick="sendMeterIPCommand(0x21, 'Read P1 Meter IP', [0x0B])" disabled data-tooltip="Read P1 meter IP address from device configuration" class="cmd-button">
                            <span class="cmd-button-text">ğŸŒ P1 Meter IP</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('meterip')">i</span>
                        </button>
                        <button onclick="sendCommand(0x24, 'Network Info')" disabled data-tooltip="IP address, gateway, subnet mask, DNS" class="cmd-button">
                            <span class="cmd-button-text">ğŸ”— Network Info</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('network')">i</span>
                        </button>
                        <button onclick="sendCommand(0x22, 'Read CT Polling Rate')" disabled data-tooltip="Read current CT meter polling rate setting" class="cmd-button">
                            <span class="cmd-button-text">ğŸ“Š CT Polling Rate</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('ctpollread')">i</span>
                        </button>
                        <button onclick="sendCommand(0x03, 'Local API Status (Runtime Info)')" disabled data-tooltip="Check Local API status from runtime information" class="cmd-button">
                            <span class="cmd-button-text">ğŸŒ Local API Status</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('apiread')">i</span>
                        </button>
                        <button onclick="sendCommand(0x10, 'Read Configuration')" disabled class="cmd-button" data-tooltip="Read device configuration including server credentials (~80 bytes)">
                            <span class="cmd-button-text">ğŸ“‹ Configuration</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('readconfig')">i</span>
                        </button>
                        <button onclick="sendCommand(0x27, 'Get Power Data Array', [0x1E])" disabled class="cmd-button" data-tooltip="Get array of last 30 power measurements">
                            <span class="cmd-button-text">ğŸ“Š Power Array (30)</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('powerarray')">i</span>
                        </button>
                        <button onclick="sendCommand(0x0A, 'Get Settings Info')" disabled class="cmd-button" data-tooltip="Get device settings information (80 bytes)">
                            <span class="cmd-button-text">âš™ï¸ Settings Info</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('settingsinfo')">i</span>
                        </button>
                        <button onclick="sendCommand(0x05, 'Get WiFi Config')" disabled class="cmd-button" data-tooltip="Get WiFi configuration and credentials">
                            <span class="cmd-button-text">ğŸ“¶ WiFi Config</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('wificonfig')">i</span>
                        </button>
                        <button onclick="sendCommand(0x0B, 'Get Time Settings')" disabled class="cmd-button" data-tooltip="Get device time and power configuration settings">
                            <span class="cmd-button-text">ğŸ• Time Settings</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('timesettings')">i</span>
                        </button>
                        <button onclick="sendCommand(0x1B, 'Get URL Config')" disabled class="cmd-button" data-tooltip="Get server URL and port configuration">
                            <span class="cmd-button-text">ğŸŒ URL Config</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('urlconfig')">i</span>
                        </button>
                    </div>
                </div>
                <div id="powerTab" class="command-tab"></div>
                <div id="systemTab" class="command-tab"></div>
                <div id="developmentTab" class="command-tab"></div>
                <div id="networkTab" class="command-tab"></div>
                <div id="advancedTab" class="command-tab"></div>
                <div id="otaTab" class="command-tab"></div>
            </div>


            <div id="dataDisplay"></div>
            
            <!-- Tabbed Log Interface -->
            <div class="log-container">
                <div class="log-tabs">
                    <button class="tab-button active" onclick="switchLogTab('activity')">Activity</button>
                    <button class="tab-button" onclick="switchLogTab('protocol')">Protocol</button>
                    <button class="tab-button" onclick="switchLogTab('errors')">Errors</button>
                </div>
                
                <div id="activityLog" class="log-tab active"></div>
                <div id="protocolLog" class="log-tab"></div>
                <div id="errorLog" class="log-tab"></div>
                
                <!-- Keep original log div for compatibility -->
                <div id="log" style="display: none;"></div>
            </div>
            
            <div class="footer">
                <p>
                    <strong>Marstek Venus Monitor</strong> - Experimental BLE Battery Diagnostics<br>
                    <a href="https://github.com/rweijnen/marstek-venus-monitor" class="github-link" target="_blank">
                        View on GitHub
                    </a> | 
                    <a href="https://github.com/tomquist/hmjs" class="github-link" target="_blank">
                        Original HMJS Project
                    </a>
                </p>
                <p id="versionInfo"><small>Version: Loading...</small></p>
                <p><small>âš ï¸ Use at your own risk - Experimental software</small></p>
            </div>
        </div>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="js/log-manager.js"></script>
    <script src="js/ui-controller.js"></script>
    <script type="module">
        // Import the TypeScript-compiled parser
        import { parseResponse } from './js/dist/data-parser-ts.js';
        
        // Set up the parser for global use
        window.dataParser = {
            parseResponse: parseResponse
        };
        console.log('âœ… TypeScript parser loaded');
    </script>
    <script src="js/ble-protocol.js"></script>
    <script src="js/integration-test.js"></script>
</body>
</html>