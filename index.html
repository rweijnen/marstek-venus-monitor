<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marstek Venus E - BLE Test Tool</title>
    <meta name="description" content="Web-based battery monitoring tool for Marstek Venus E batteries via Bluetooth Low Energy">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Command Info Modal -->
    <div id="infoModal" class="info-modal">
        <div class="info-modal-content">
            <span class="info-modal-close" onclick="closeInfoModal()">&times;</span>
            <div id="commandDetails" class="command-details"></div>
        </div>
    </div>

    <!-- Disclaimer Modal -->
    <div id="disclaimerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">âš ï¸ EXPERIMENTAL SOFTWARE WARNING âš ï¸</div>
            
            <div class="disclaimer-text">
                <p><strong>This is highly experimental testing software for Marstek Venus E batteries.</strong></p>
                
                <div class="warning-box">
                    <strong>IMPORTANT WARNINGS:</strong>
                    <ul>
                        <li>This software can send commands to your battery system</li>
                        <li>Some commands may modify battery settings or behavior</li>
                        <li>Improper use could potentially damage your equipment</li>
                        <li>This tool is for advanced users and developers only</li>
                        <li>Use in a controlled environment with proper safety precautions</li>
                    </ul>
                </div>
                
                <p><strong>By continuing, you acknowledge that:</strong></p>
                <ul>
                    <li>You understand the experimental nature of this software</li>
                    <li>You accept full responsibility for any consequences</li>
                    <li>You will not hold the developers liable for any damages</li>
                    <li>You have proper knowledge of battery systems and safety</li>
                    <li>You will use this tool at your own risk</li>
                </ul>
                
                <p><strong>Supported Equipment:</strong> Marstek Venus E batteries with "MST_ACCP" and "MST-TPM" Bluetooth names.</p>
                
                <p><strong>Browser Requirements:</strong> Chrome, Edge, or Opera with Web Bluetooth support.</p>
            </div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="acceptRisk"> 
                <label for="acceptRisk">I understand the risks and agree to proceed at my own responsibility</label>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-decline" onclick="declineAndExit()">âŒ Exit Safely</button>
                <button class="btn-accept" id="acceptBtn" disabled onclick="acceptAndContinue()">âœ… Accept Risk & Continue</button>
            </div>
        </div>
    </div>

    <!-- Main Interface -->
    <div class="main-interface" id="mainInterface">
        <div class="container">
            <h1>ğŸ”‹ Marstek Venus E - BLE Test Tool</h1>
            <p class="subtitle">Advanced BLE monitoring and diagnostics for Marstek battery systems</p>
            
            <!-- Version Links -->
            <div style="text-align: center; margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                <span style="color: #666; font-size: 14px;">ğŸ“ You're using: <strong>v2.0.0-beta (Latest)</strong></span>
                <span style="margin: 0 10px;">|</span>
                <a href="https://rweijnen.github.io/marstek-venus-monitor/" style="color: #007bff; text-decoration: none;">
                    ğŸ”’ Switch to v1.0.0 (Stable)
                </a>
            </div>
            
            <div class="status">
                <span>Status: <span id="status" class="disconnected">Disconnected</span></span>
                <div>
                    <button onclick="connect()" id="connectBtn" class="btn-connect">Connect to Marstek</button>
                    <button onclick="disconnect()" id="disconnectBtn" disabled>Disconnect</button>
                    <button onclick="disconnectAll()" id="disconnectAllBtn">Disconnect All</button>
                    <button onclick="runAllTests()" id="runAllBtn" disabled>ğŸ§ª Run All Tests</button>
                    <button onclick="clearAll()">Clear All</button>
                </div>
            </div>
            
            <!-- Connection Status Messages -->
            <div id="connectionStatus" class="connection-status" style="display: none;">
                <div id="connectionMessage"></div>
            </div>

            <!-- Command Tabs Interface -->
            <div class="command-tabs-container">
                <div class="command-tabs">
                    <button class="command-tab-button active" onclick="switchCommandTab('read')">ğŸ“– Read</button>
                    <button class="command-tab-button" onclick="switchCommandTab('power')">âš¡ Power</button>
                    <button class="command-tab-button" onclick="switchCommandTab('system')">âš™ï¸ System</button>
                    <button class="command-tab-button" onclick="switchCommandTab('development')">ğŸ”§ Dev</button>
                    <button class="command-tab-button" onclick="switchCommandTab('network')">ğŸ•° Network</button>
                    <button class="command-tab-button" onclick="switchCommandTab('advanced')">ğŸ”§ Advanced</button>
                    <button class="command-tab-button" onclick="switchCommandTab('ota')">ğŸ”¥ OTA</button>
                </div>
                
                <!-- Command Tab Contents (Loaded Dynamically) -->
                <div id="readTab" class="command-tab active" data-loaded="true">
                    <div class="section-caption">
                        ğŸ“– <strong>Read Commands:</strong> These commands safely read information from your device including power status, battery data, network configuration, and system logs. No settings are modified.
                    </div>
                    <div class="command-grid">
                        <button onclick="sendCommand(0x03, 'Runtime Info')" disabled data-tooltip="Real-time power flow, temperatures, and system status" class="cmd-button">
                            <span class="cmd-button-text">âš¡ Runtime Info</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('runtime')">i</span>
                        </button>
                        <button onclick="sendCommand(0x04, 'Device Info')" disabled data-tooltip="Device model, MAC address, and firmware versions" class="cmd-button">
                            <span class="cmd-button-text">ğŸ“± Device Info</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('device')">i</span>
                        </button>
                        <button onclick="sendCommand(0x08, 'WiFi Info')" disabled data-tooltip="Connected WiFi network name (SSID)" class="cmd-button">
                            <span class="cmd-button-text">ğŸ“¶ WiFi Info</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('wifi')">i</span>
                        </button>
                        <button onclick="sendCommand(0x0D, 'Developer Mode Info')" disabled data-tooltip="Development mode configuration and debug parameters" class="cmd-button">
                            <span class="cmd-button-text">ğŸ› ï¸ Developer Mode Info</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('system')">i</span>
                        </button>
                        <button onclick="sendCommand(0x13, 'Error Codes')" disabled data-tooltip="Historical error codes with timestamps" class="cmd-button">
                            <span class="cmd-button-text">ğŸš¨ Error Codes</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('errors')">i</span>
                        </button>
                        <button onclick="sendCommand(0x14, 'BMS Data')" disabled data-tooltip="Battery voltages, current, SOC, and cell data" class="cmd-button">
                            <span class="cmd-button-text">ğŸ”‹ BMS Data</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('bms')">i</span>
                        </button>
                        <button onclick="sendCommand(0x1A, 'Config Data')" disabled data-tooltip="System configuration parameters" class="cmd-button">
                            <span class="cmd-button-text">âš™ï¸ Config Data</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('config')">i</span>
                        </button>
                        <button onclick="sendCommand(0x1C, 'Event Log')" disabled data-tooltip="System event history with timestamps" class="cmd-button">
                            <span class="cmd-button-text">ğŸ“ Event Log</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('events')">i</span>
                        </button>
                        <button onclick="sendMeterIPCommand(0x21, 'Read P1 Meter IP', [0x0B])" disabled data-tooltip="Read P1 meter IP address from device configuration" class="cmd-button">
                            <span class="cmd-button-text">ğŸŒ Read P1 Meter IP</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('meterip')">i</span>
                        </button>
                        <button onclick="sendCommand(0x24, 'Network Info')" disabled data-tooltip="IP address, gateway, subnet mask, DNS" class="cmd-button">
                            <span class="cmd-button-text">ğŸ”— Network Info</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('network')">i</span>
                        </button>
                        <button onclick="sendCommand(0x22, 'Read CT Polling Rate')" disabled data-tooltip="Read current CT meter polling rate setting" class="cmd-button">
                            <span class="cmd-button-text">ğŸ“Š Read CT Polling Rate</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('ctpollread')">i</span>
                        </button>
                        <button onclick="sendCommand(0x03, 'Local API Status (Runtime Info)')" disabled data-tooltip="Check Local API status from runtime information" class="cmd-button">
                            <span class="cmd-button-text">ğŸŒ Local API Status</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('apiread')">i</span>
                        </button>
                        <button onclick="sendCommand(0x10, 'Read Configuration')" disabled class="cmd-button" data-tooltip="Read device configuration including server credentials (~80 bytes)">
                            <span class="cmd-button-text">ğŸ“‹ Read Configuration</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('readconfig')">i</span>
                        </button>
                        <button onclick="sendCommand(0x27, 'Get Power Data Array', [0x1E])" disabled class="cmd-button" data-tooltip="Get array of last 30 power measurements">
                            <span class="cmd-button-text">ğŸ“Š Get Power Array (30)</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('powerarray')">i</span>
                        </button>
                        <button onclick="sendCommand(0x0A, 'Get Settings Info')" disabled class="cmd-button" data-tooltip="Get device settings information (80 bytes)">
                            <span class="cmd-button-text">âš™ï¸ Get Settings Info</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('settingsinfo')">i</span>
                        </button>
                        <button onclick="sendCommand(0x05, 'Get WiFi Config')" disabled class="cmd-button" data-tooltip="Get WiFi configuration and credentials">
                            <span class="cmd-button-text">ğŸ“¶ Get WiFi Config</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('wificonfig')">i</span>
                        </button>
                        <button onclick="sendCommand(0x0B, 'Get Time Settings')" disabled class="cmd-button" data-tooltip="Get device time and power configuration settings">
                            <span class="cmd-button-text">ğŸ• Get Time Settings</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('timesettings')">i</span>
                        </button>
                        <button onclick="sendCommand(0x1B, 'Get URL Config')" disabled class="cmd-button" data-tooltip="Get server URL and port configuration">
                            <span class="cmd-button-text">ğŸŒ Get URL Config</span>
                            <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('urlconfig')">i</span>
                        </button>
                    </div>
                </div>
                <div id="powerTab" class="command-tab"></div>
                <div id="systemTab" class="command-tab"></div>
                <div id="developmentTab" class="command-tab"></div>
                <div id="networkTab" class="command-tab"></div>
                <div id="advancedTab" class="command-tab"></div>
                <div id="otaTab" class="command-tab"></div>
            </div>

            <!-- System Configuration Commands -->
            <div class="command-section">
                <h3>âš™ï¸ System Configuration (Modify Settings)</h3>
                <div class="section-caption">
                    âš ï¸ <strong>System Settings:</strong> These commands change operational modes including EPS (Emergency Power Supply), AC input behavior, and generator control. Settings persist after power cycle.
                </div>
                <div class="command-grid">
                    <button onclick="sendCommand(0x02, 'Set Server Type 0', [0x00])" disabled class="btn-warning cmd-button" data-tooltip="Configure server connection type">
                        <span class="cmd-button-text">Set Server Type 0</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('servertype')">i</span>
                    </button>
                    <button onclick="sendCommand(0x0F, 'Enable EPS', [0x01])" disabled class="btn-warning cmd-button" data-tooltip="Enable Emergency Power Supply mode">
                        <span class="cmd-button-text">Enable EPS</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('epsenable')">i</span>
                    </button>
                    <button onclick="sendCommand(0x0F, 'Disable EPS', [0x00])" disabled class="btn-warning cmd-button" data-tooltip="Disable Emergency Power Supply mode">
                        <span class="cmd-button-text">Disable EPS</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('epsdisable')">i</span>
                    </button>
                    <button onclick="sendCommand(0x0E, 'Enable Auto Mode Change', [0x01])" disabled class="btn-warning cmd-button" data-tooltip="Enable automatic work mode switching">
                        <span class="cmd-button-text">ğŸ”„ Auto Mode ON</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('automode')">i</span>
                    </button>
                    <button onclick="sendCommand(0x0E, 'Disable Auto Mode Change', [0x00])" disabled class="btn-warning cmd-button" data-tooltip="Disable automatic work mode switching">
                        <span class="cmd-button-text">ğŸ”„ Auto Mode OFF</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('automodedis')">i</span>
                    </button>
                    <button onclick="sendCommand(0x23, 'Enable Generator', [0x01])" disabled class="btn-warning cmd-button" data-tooltip="Enable generator input">
                        <span class="cmd-button-text">Enable Generator</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('genenable')">i</span>
                    </button>
                    <button onclick="sendCommand(0x23, 'Disable Generator', [0x00])" disabled class="btn-warning cmd-button" data-tooltip="Disable generator input">
                        <span class="cmd-button-text">Disable Generator</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('gendisable')">i</span>
                    </button>
                    <button onclick="sendCommand(0x28, 'Enable Local API (Port 30000)', [0x01, 0x30, 0x75])" disabled class="btn-warning cmd-button" data-tooltip="Enable local API on default port 30000">
                        <span class="cmd-button-text">Enable Local API (30000)</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('apienable30000')">i</span>
                    </button>
                    <button onclick="setLocalApiPort()" disabled class="btn-warning cmd-button" data-tooltip="Enable local API with custom port number">
                        <span class="cmd-button-text">Enable Local API (Custom Port)</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('apicustom')">i</span>
                    </button>
                    <button onclick="sendCommand(0x28, 'Disable Local API', [0x00, 0x00, 0x00])" disabled class="btn-warning cmd-button" data-tooltip="Disable local API access">
                        <span class="cmd-button-text">Disable Local API</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('apidisable')">i</span>
                    </button>
                    <button onclick="sendCommand(0x20, 'Set CT Polling Rate: 0', [0x00])" disabled class="btn-warning cmd-button" data-tooltip="Set CT meter polling rate to 0 (fastest)">
                        <span class="cmd-button-text">CT Polling: Rate 0 (Fastest)</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('ctpoll0')">i</span>
                    </button>
                    <button onclick="sendCommand(0x20, 'Set CT Polling Rate: 1', [0x01])" disabled class="btn-warning cmd-button" data-tooltip="Set CT meter polling rate to 1 (medium)">
                        <span class="cmd-button-text">CT Polling: Rate 1 (Medium)</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('ctpoll1')">i</span>
                    </button>
                    <button onclick="sendCommand(0x20, 'Set CT Polling Rate: 2', [0x02])" disabled class="btn-warning cmd-button" data-tooltip="Set CT meter polling rate to 2 (slowest)">
                        <span class="cmd-button-text">CT Polling: Rate 2 (Slowest)</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('ctpoll2')">i</span>
                    </button>
                    <button onclick="sendCommand(0x20, 'Set CT Polling Rate: 3', [0x03])" disabled class="btn-warning cmd-button" data-tooltip="Set CT meter polling rate to 3 (extended/custom)">
                        <span class="cmd-button-text">CT Polling: Rate 3 (Extended)</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('ctpoll3')">i</span>
                    </button>
                    <button onclick="sendConfigWriteCommand()" disabled class="btn-danger cmd-button" data-tooltip="Write configuration data with server credentials">
                        <span class="cmd-button-text">ğŸ’¾ Write Configuration</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('writeconfig')">i</span>
                    </button>
                    <button onclick="sendCommand(0x09, 'Set Work Mode 0 (Off)', [0x00])" disabled class="btn-warning cmd-button" data-tooltip="Set device work mode to 0 (Off)">
                        <span class="cmd-button-text">âš¡ Work Mode: Off</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('workmode0')">i</span>
                    </button>
                    <button onclick="sendCommand(0x09, 'Set Work Mode 1 (On)', [0x01])" disabled class="btn-warning cmd-button" data-tooltip="Set device work mode to 1 (On) with configuration">
                        <span class="cmd-button-text">âš¡ Work Mode: On</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('workmode1')">i</span>
                    </button>
                    <button onclick="sendCommand(0x18, 'Set Current Time')" disabled class="btn-warning cmd-button" data-tooltip="Set device time and date to current browser time">
                        <span class="cmd-button-text">ğŸ• Sync Time</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('synctime')">i</span>
                    </button>
                    <button onclick="sendCommand(0x19, 'Set Battery Mode 0', [0x00])" disabled class="btn-warning cmd-button" data-tooltip="Set battery operation mode to 0">
                        <span class="cmd-button-text">ğŸ”‹ Battery Mode 0</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('batmode0')">i</span>
                    </button>
                    <button onclick="sendCommand(0x19, 'Set Battery Mode 1', [0x01])" disabled class="btn-warning cmd-button" data-tooltip="Set battery operation mode to 1">
                        <span class="cmd-button-text">ğŸ”‹ Battery Mode 1</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('batmode1')">i</span>
                    </button>
                </div>
            </div>

            <!-- Development/Diagnostic Commands -->
            <div class="command-section">
                <h3>ğŸ”§ Development & Diagnostics</h3>
                <div class="section-caption">
                    âš ï¸ <strong>Advanced:</strong> These commands are for development and diagnostics. Use with caution.
                </div>
                <div class="command-grid">
                    <button onclick="sendCommand(0x0C, 'Enable Dev Mode', [0x0A, 0x0B, 0x0C, 0x01])" disabled class="btn-danger cmd-button" data-tooltip="Enable development mode (requires magic bytes)">
                        <span class="cmd-button-text">ğŸ”“ Enable Dev Mode</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('devmode')">i</span>
                    </button>
                    <button onclick="sendCommand(0x0C, 'Disable Dev Mode', [0x0A, 0x0B, 0x0C, 0x00])" disabled class="btn-warning cmd-button" data-tooltip="Disable development mode">
                        <span class="cmd-button-text">ğŸ”’ Disable Dev Mode</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('devmodedisable')">i</span>
                    </button>
                    <button onclick="sendCommand(0x1F, 'Trigger FW Upgrade', [0x0A, 0x0B, 0x0C])" disabled class="btn-danger cmd-button" data-tooltip="Trigger firmware upgrade mode (requires magic bytes)">
                        <span class="cmd-button-text">â¬†ï¸ FW Upgrade Mode</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('fwupgrade')">i</span>
                    </button>
                    <button onclick="sendCommand(0x1D, 'System Restart')" disabled class="btn-warning cmd-button" data-tooltip="Restart the system">
                        <span class="cmd-button-text">ğŸ”„ System Restart</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('restart')">i</span>
                    </button>
                    <button onclick="sendCommand(0x20, 'Parallel Machine Ready', [0x0A, 0x0B, 0x0C, 0x01])" disabled class="btn-danger cmd-button" data-tooltip="Set parallel machine to ready state (requires magic bytes)">
                        <span class="cmd-button-text">ğŸ”— Parallel Ready</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('parallelready')">i</span>
                    </button>
                    <button onclick="sendCommand(0x20, 'Parallel Machine ON', [0x0A, 0x0B, 0x0C, 0x02])" disabled class="btn-danger cmd-button" data-tooltip="Enable parallel machine operation (requires magic bytes)">
                        <span class="cmd-button-text">ğŸ”— Parallel ON</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('parallelon')">i</span>
                    </button>
                    <button onclick="sendCommand(0x20, 'Parallel Machine OFF', [0x0A, 0x0B, 0x0C, 0x00])" disabled class="btn-warning cmd-button" data-tooltip="Disable parallel machine operation (requires magic bytes)">
                        <span class="cmd-button-text">ğŸ”— Parallel OFF</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('paralleloff')">i</span>
                    </button>
                </div>
            </div>

            <!-- Time/Network Commands -->
            <div class="command-section">
                <h3>ğŸ•° Time & Network (Modify Settings)</h3>
                <div class="section-caption">
                    âš ï¸ <strong>Time & Network:</strong> These commands update device clock and network configuration. IP changes may affect remote monitoring.
                </div>
                <div class="command-grid">
                    <button onclick="setCurrentDateTime()" disabled class="btn-warning cmd-button" data-tooltip="Sync device clock with browser time">
                        <span class="cmd-button-text">Set Current Time</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('settime')">i</span>
                    </button>
                    <button onclick="sendCommand(0x21, 'Write Test IP', [0x0A, 0x31, 0x39, 0x32, 0x2E, 0x31, 0x36, 0x38, 0x2E, 0x31, 0x2E, 0x31])" disabled class="btn-warning cmd-button" data-tooltip="Write test IP 192.168.1.1 to meter config">
                        <span class="cmd-button-text">ğŸŒ Write Test IP</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('writemeter')">i</span>
                    </button>
                </div>
            </div>

            <!-- Advanced/Dangerous Commands -->
            <div class="command-section">
                <h3>ğŸ”§ Advanced Commands (Use with Extreme Caution)</h3>
                <div class="section-caption" style="background: #f8d7da; border-left-color: #dc3545;">
                    ğŸš« <strong>DANGER ZONE:</strong> These commands can reset the device, enable firmware updates, or configure parallel operation. May cause data loss or require physical access to recover.
                </div>
                <div class="command-grid">
                    <button onclick="sendCommand(0x0C, 'System Reset', [0x0A, 0x0B, 0x0C, 0x01])" disabled class="btn-danger cmd-button" data-tooltip="Restart the device immediately">
                        <span class="cmd-button-text">âš ï¸ System Reset</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('reset')">i</span>
                    </button>
                    <button onclick="sendCommand(0x1F, 'Upgrade Mode', [0x0A, 0x0B, 0x0C])" disabled class="btn-danger cmd-button" data-tooltip="Enter firmware upgrade mode">
                        <span class="cmd-button-text">âš ï¸ Upgrade Mode</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('upgrade')">i</span>
                    </button>
                    <button onclick="sendCommand(0x20, 'Parallel Ready', [0x0A, 0x0B, 0x0C, 0x01])" disabled class="btn-danger cmd-button" data-tooltip="Configure for parallel operation">
                        <span class="cmd-button-text">âš ï¸ Parallel Ready</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('parallel')">i</span>
                    </button>
                    <button onclick="sendCommand(0x06, 'Factory Reset (WiFi)', [0x01])" disabled class="btn-danger cmd-button" data-tooltip="Factory reset WiFi settings only">
                        <span class="cmd-button-text">ğŸ­ Factory Reset WiFi</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('factoryreset1')">i</span>
                    </button>
                    <button onclick="sendCommand(0x06, 'Factory Reset (Full)', [0x02])" disabled class="btn-danger cmd-button" data-tooltip="Complete factory reset - all settings">
                        <span class="cmd-button-text">ğŸ­ Factory Reset Full</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('factoryreset2')">i</span>
                    </button>
                </div>
            </div>
            
            <!-- OTA Firmware Update (EXPERIMENTAL) -->
            <div class="command-section">
                <h3>ğŸ”¥ OTA Firmware Update (EXTREMELY DANGEROUS)</h3>
                <div class="section-caption" style="background: #721c24; color: white; border-left-color: #f5c6cb;">
                    âš ï¸ <strong>EXTREME DANGER:</strong> OTA firmware updates can permanently brick your device! Only use if you have a backup and recovery method. This is reverse-engineered and experimental.
                </div>
                <div class="command-grid">
                    <input type="file" id="firmwareFile" accept=".bin" style="display: none;" onchange="handleFirmwareFile(event)">
                    <button onclick="document.getElementById('firmwareFile').click()" disabled class="btn-danger cmd-button" data-tooltip="Select .bin firmware file to upload">
                        <span class="cmd-button-text">ğŸ“ Select Firmware</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('otasize')">i</span>
                    </button>
                    <button onclick="performOTAUpdate()" disabled class="btn-danger cmd-button" id="otaStartBtn" data-tooltip="Start complete OTA firmware upload process">
                        <span class="cmd-button-text">âš¡ Start OTA Update</span>
                        <span class="info-icon" onclick="event.stopPropagation(); showCommandInfo('otaactivate')">i</span>
                    </button>
                </div>
                <div id="otaFileInfo" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 14px; color: #666;">
                    No firmware file selected
                </div>
                <div id="otaProgressContainer" style="display: none; margin-top: 10px;">
                    <div style="background: #333; border-radius: 5px; overflow: hidden;">
                        <div id="otaProgress" style="width: 0%; height: 20px; background: #28a745; transition: width 0.3s;"></div>
                    </div>
                    <div id="otaStatus" style="margin-top: 5px; color: #888;">Ready to start...</div>
                </div>
            </div>

            <div id="dataDisplay"></div>
            
            <!-- Tabbed Log Interface -->
            <div class="log-container">
                <div class="log-tabs">
                    <button class="tab-button active" onclick="switchLogTab('activity')">Activity</button>
                    <button class="tab-button" onclick="switchLogTab('protocol')">Protocol</button>
                    <button class="tab-button" onclick="switchLogTab('errors')">Errors</button>
                </div>
                
                <div id="activityLog" class="log-tab active"></div>
                <div id="protocolLog" class="log-tab"></div>
                <div id="errorLog" class="log-tab"></div>
                
                <!-- Keep original log div for compatibility -->
                <div id="log" style="display: none;"></div>
            </div>
            
            <div class="footer">
                <p>
                    <strong>Marstek Venus E Monitor</strong> - Experimental BLE Battery Diagnostics<br>
                    <a href="https://github.com/rweijnen/marstek-venus-monitor" class="github-link" target="_blank">
                        View on GitHub
                    </a> | 
                    <a href="https://github.com/tomquist/hmjs" class="github-link" target="_blank">
                        Original HMJS Project
                    </a>
                </p>
                <p id="versionInfo"><small>Version: Loading...</small></p>
                <p><small>âš ï¸ Use at your own risk - Experimental software</small></p>
            </div>
        </div>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="js/log-manager.js"></script>
    <script src="js/ui-controller.js"></script>
    <script type="module">
        // Import the TypeScript-compiled parser
        import { parseResponse } from './js/dist/data-parser-ts.js';
        
        // Set up the parser for global use
        window.dataParser = {
            parseResponse: parseResponse
        };
        console.log('âœ… TypeScript parser loaded');
    </script>
    <script src="js/ble-protocol.js"></script>
    <script src="js/integration-test.js"></script>
</body>
</html>